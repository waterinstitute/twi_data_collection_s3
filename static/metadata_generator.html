<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" />
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="col-12">
<h1>Metadata Generator <small class="text-muted">Dataset description metadata</small></h1>
<p class="lead">
  This small app allows you to create a download a valid metadata file. <br/>
  Please start by selecting the schema againts you want to validate,
  either using bounds_huc (a huc code {4,6, or 8}) or a bounds_wkt
  (A <acronym title="Well Known Text">WKT</acronym> expression that define the polygon)
  to define the dataset extends.
  <br/>
  The required fields are shown by default,
  but <b>there are also optional properties you can add or remove using the properties button in each object</b>.
  You can also add any other property you consider necessary (the schema is flexible).
</p>
<p> Do you want to  <a class="btn btn-light" data-toggle="collapse" href="#uploadExisting" role="button" aria-expanded="false" aria-controls="collapseExample">
    load an existing metadata file
  </a>?
  <div class="collapse" id="uploadExisting">
  <div class="card card-body">
    <input type="file" id="input-file"/>
  </div>
</div>
</div>
</div>
 <div class="row">
	<div class="col-8" id='editor'></div>
	<div class="col-4" >
	<div class="container-fluid">
		<div class="row">
		<div class="col-12">
		<pre class="language-yaml"><code id='yaml-result' class="language-yaml"></code></pre>
		</div>
		</div>
		<div class="row">
			<a id="btn-download" class="btn btn-outline-primary" download="metadata.yaml">Validate and Download</a>
		</div>
	</div>
	</div>
 </div>
</div>
<div class="modal fade" id="alert-validation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">There are some validation errors, please fix them before downloading.</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
	  <div class="alert alert-danger" role="alert">
        <div id="alert-text"></div>
	</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/yamljs/0.3.0/yaml.min.js" integrity="sha512-f/K0Q5lZ1SrdNdjc2BO2I5kTx8E5Uw1EU3PhSUB9fYPohap5rPWEmQRCjtpDxNmQB4/+MMI/Cf+nvh1VSiwrTA==" crossorigin="anonymous"></script><script>
JSONEditor.defaults.options.theme = 'bootstrap4';
JSONEditor.defaults.editors.object.options = {"collapsed":false, //"remove_empty_properties":true
}
const element = document.getElementById('editor');
var jsoneditor = new JSONEditor(element, {
  schema: {
      type: "object",
      properties: {
          name: { "type": "string" }
      }
  }
});
function createForm(schema){
	var $editor = document.getElementById('editor');
	if(jsoneditor) jsoneditor.destroy();
	jsoneditor = new JSONEditor($editor,{
		schema: schema,
		disable_edit_json: true,
		display_required_only: true,
	});
	jsoneditor.on('change', ()=>{
		var yaml_result= YAML.stringify(jsoneditor.getValue(),4,2);
		$("#yaml-result").text(yaml_result)
		Prism.highlightElement($("#yaml-result")[0])
		var dataStr = "data:text/yaml;charset=utf-8,"+encodeURIComponent(yaml_result);
		$("#btn-download").attr("href",dataStr);
	})
}
$.getJSON( "conf/metadata.jsonschema.json", createForm);
function format_errors(errors){
	var output = "";
	for (var i in errors){
		if (errors[i].property == "anyOf"){
			continue;
		}
		output+="\n"+errors[i].path.replace(/^root[.]/,"")+": "+errors[i].message;
	}
	return output;
}
function validate(e){
	if(jsoneditor){
		const errors = jsoneditor.validate();
		console.log(errors)
		if(errors.length)
		{
			e.preventDefault()
			$("#alert-validation #alert-text").html("<pre>"+format_errors(errors)+"</pre>");
			$("#alert-validation").modal()
			return false;
		}
		$("#alert-validation #alert-text").text("");
		$("#alert-validation").hide()
		return true;
	}
}
$(function(){
	$("#btn-download").on("click", validate)
}
)
   document.getElementById('input-file').addEventListener('change', readFile, false);

   function readFile (evt) {
       var files = evt.target.files;
       var file = files[0];
       var reader = new FileReader();
       reader.onload = function(event) {
	     obj = YAML.parse(event.target.result)
		 if(Array.isArray(obj)){
			alert("The selected file contains multiple documents, only the first one is loaded")
			jsoneditor.setValue(obj[0]);
		 }else{
			jsoneditor.setValue(obj);
		 }
       }
       reader.readAsText(file)
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js" integrity="sha512-YBk7HhgDZvBxmtOfUdvX0z8IH2d10Hp3aEygaMNhtF8fSOvBZ16D/1bXZTJV6ndk/L/DlXxYStP8jrF77v2MIg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-yaml.min.js" integrity="sha512-QRKKJS95wG2dOCdc7Cm0Zbu+L04xY8fTwhHG3UnqZPMiFrAN8uXrqVTx//eqvTaoYwNJ7oFN3Vej5gnJ+GAxkw==" crossorigin="anonymous"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-12915155-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-12915155-3');
</script>
</body>
</html>
